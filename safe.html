<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DataGate Safe Uploader</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:900px;margin:40px auto;padding:0 16px;}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .ok{background:#ecfdf5;border:1px solid #10b981;padding:12px;border-radius:8px;margin-top:12px}
  .ng{background:#fef2f2;border:1px solid #ef4444;padding:12px;border-radius:8px;margin-top:12px}
  .muted{color:#6b7280}
  button{padding:8px 12px;border-radius:10px;border:1px solid #d1d5db;background:white;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  input[type="email"]{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;min-width:280px}
</style>

<h1>ğŸ›Ÿ DataGate Safe Uploader</h1>
<p class="muted">ç‹¬ç«‹ãƒ†ã‚¹ãƒˆç”¨UIã€‚æ—¢å­˜UIã¨ç„¡é–¢ä¿‚ã«å‹•ãã¾ã™ã€‚</p>

<div class="card">
  <div class="row">
    <input id="fileInput" type="file">
    <span>é¸æŠä¸­: <strong id="fileName">æœªé¸æŠ</strong></span>
  </div>

  <div class="row">
    <input id="emailInput" type="email" placeholder="é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
    <button id="uploadBtn" type="button">â¬† ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
    <span id="loading" class="muted" style="display:none">â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦</span>
  </div>

  <div id="result" style="display:none"></div>
</div>

<script>
(function(){
  var fileInput  = document.getElementById("fileInput");
  var fileNameEl = document.getElementById("fileName");
  var emailInput = document.getElementById("emailInput");
  var uploadBtn  = document.getElementById("uploadBtn");
  var loadingEl  = document.getElementById("loading");
  var resultEl   = document.getElementById("result");

  function safeLinkFrom(data){
    var fid = (data && (data.fileId || data.id)) || "";
    if (data && data.downloadLink) return String(data.downloadLink);
    if (fid) return location.origin + "/download.html?id=" + fid;
    return "";
  }

  fileInput.addEventListener("change", function(e){
    var f = e.target && e.target.files && e.target.files[0];
    fileNameEl.textContent = f ? f.name : "æœªé¸æŠ";
  });

  uploadBtn.addEventListener("click", function(){
    var f = fileInput && fileInput.files && fileInput.files[0];
    if (!f){ alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    var email = (emailInput.value || "").trim();
    if (!email || email.indexOf("@") === -1){ alert("æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    uploadBtn.disabled = true;
    loadingEl.style.display = "inline";
    resultEl.style.display = "none";
    resultEl.className = ""; resultEl.innerHTML = "";

    var fd = new FormData();
    fd.append("file", f);
    fd.append("recipientEmail", email);

    fetch("/api/upload", { method:"POST", body: fd })
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (data && data.success){
          var link = safeLinkFrom(data);
          resultEl.className = "ok";
          resultEl.innerHTML =
            "<div><strong>âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼</strong></div>"
            + "<div>" + (data.message || "ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ") + "</div>"
            + "<div style='margin-top:6px'><strong>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯:</strong></div>"
            + "<div class='row' style='margin-top:4px'>"
            +   "<a href='" + link + "' target='_blank'>ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>"
            +   "<button type='button' onclick=\"navigator.clipboard.writeText('" + link + "').then(()=>alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'))\">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>"
            + "</div>";
          resultEl.style.display = "block";
        }else{
          throw new Error((data && data.error) || "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      })
      .catch(function(err){
        resultEl.className = "ng";
        resultEl.innerHTML = "<div><strong>âŒ ã‚¨ãƒ©ãƒ¼</strong></div><div>" + (err && err.message ? err.message : String(err)) + "</div>";
        resultEl.style.display = "block";
      })
      .finally(function(){
        uploadBtn.disabled = false;
        loadingEl.style.display = "none";
      });
  });
})();
</script>
