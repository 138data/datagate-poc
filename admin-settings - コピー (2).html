<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DataGate â€” ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</title>
  <style>
    :root{--primary:#667eea;--bg:#f7f7fb;--card:#fff;--muted:#6b7280}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Segoe UI",Tahoma,Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:24px;min-height:100vh}
    .wrap{max-width:980px;margin:0 auto;background:var(--card);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:28px;position:relative}
    h1{margin:0 0 4px;font-size:28px;color:#111}
    .sub{color:var(--muted);margin:0 0 24px}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:18px}
    .card h2{font-size:18px;margin:0 0 8px;color:#111}
    .help{color:var(--muted);font-size:12px;margin-top:4px}
    label{display:block;font-weight:600;margin:12px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1.5px solid #e5e7eb;border-radius:10px;font-size:14px}
    textarea{min-height:88px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{appearance:none;border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;transition:all 0.2s}
    button:hover{opacity:0.9;transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    .primary{background:var(--primary);color:#fff}
    .ghost{background:#eef2ff;color:#3730a3}
    .secondary{background:#f3f4f6;color:#1f2937} /* <--- è¿½åŠ ã—ãŸCSS */
    .danger{background:#fee2e2;color:#991b1b}
    .success{background:#d1fae5;color:#065f46;border:2px solid #10b981;font-weight:700;font-size:16px;padding:16px 20px}
    .warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
    .error{background:#fee2e2;color:#991b1b;border:2px solid #ef4444;font-weight:700;font-size:16px;padding:16px 20px}
    .msg{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;min-width:400px;max-width:600px;padding:16px 24px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);display:none;animation:slideDown 0.3s ease}
    @keyframes slideDown{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translate(-50%,0)}}
    .footer{margin-top:22px;color:#6b7280;font-size:12px}
  </style>
</head>
<body>
  <div id="msg" class="msg"></div>
  <div class="wrap">
    <h1>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h1>
    <p class="sub">ã‚µã‚¤ãƒˆæƒ…å ± / ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ / ãƒ¡ãƒ¼ãƒ« / ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</p>
    <div class="grid">
      <section class="card">
        <h2>1) å…¨èˆ¬</h2>
        <label>ã‚µã‚¤ãƒˆå</label>
        <input id="siteName" placeholder="ä¾‹) 138DataGate">
        <label>ãƒ­ã‚´URL</label>
        <input id="logoUrl" placeholder="https://.../logo.png">
        <label>ãŠçŸ¥ã‚‰ã›ï¼ˆãƒãƒŠãƒ¼/æ³¨è¨˜ãªã©ï¼‰</label>
        <textarea id="notice" placeholder="ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆå®š: ..."></textarea>
      </section>
      <section class="card">
        <h2>2) ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h2>
        <div class="row">
          <div>
            <label>ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ï¼ˆåˆ†ï¼‰</label>
            <input id="sessionTimeout" type="number" min="5" step="5" placeholder="60">
          </div>
          <div>
            <label>JWTæœ‰åŠ¹æœŸé™ï¼ˆåˆ†ï¼‰</label>
            <input id="jwtExpiry" type="number" min="5" step="5" placeholder="60">
          </div>
        </div>
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼</label>
        <select id="passwordPolicy">
          <option value="low">Lowï¼ˆè‹±æ•°å­—6æ–‡å­—ä»¥ä¸Šï¼‰</option>
          <option value="medium">Mediumï¼ˆè‹±å¤§å°ãƒ»æ•°å­—8æ–‡å­—ä»¥ä¸Šï¼‰</option>
          <option value="high">Highï¼ˆè‹±å¤§å°ãƒ»æ•°å­—ãƒ»è¨˜å·12æ–‡å­—ä»¥ä¸Šï¼‰</option>
        </select>
        <label>IPã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãƒªã‚¹ãƒˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
        <input id="ipAllowlist" placeholder="203.0.113.10, 198.51.100.42">
      </section>
      <section class="card">
        <h2>3) ãƒ¡ãƒ¼ãƒ«</h2>
        <label>é€ä¿¡æ–¹å¼</label>
        <select id="mailProvider">
          <option value="sendgrid">SendGrid</option>
          <option value="smtp">SMTP</option>
        </select>
        <div id="sendgridBlock">
          <label>SendGrid é€ä¿¡å…ƒã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input id="sgFrom" placeholder="no-reply@example.com">
        </div>
        <div id="smtpBlock" style="display:none">
          <div class="row">
            <div>
              <label>SMTPãƒ›ã‚¹ãƒˆ</label>
              <input id="smtpHost" placeholder="smtp.example.com">
            </div>
            <div>
              <label>ãƒãƒ¼ãƒˆ</label>
              <input id="smtpPort" type="number" placeholder="587">
            </div>
          </div>
          <div class="row">
            <div>
              <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
              <input id="smtpUser" placeholder="user@example.com">
            </div>
            <div>
              <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
              <input id="smtpPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
          </div>
          <label>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</label>
          <select id="smtpSecure">
            <option value="starttls">STARTTLS (587)</option>
            <option value="ssl">SSL/TLS (465)</option>
            <option value="plain">PLAIN (25)</option>
          </select>
          <label>é€ä¿¡å…ƒã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input id="smtpFrom" placeholder="no-reply@example.com">
          <div class="btns">
            <button class="ghost" id="btnTestMail">ãƒ†ã‚¹ãƒˆé€ä¿¡</button>
            <button class="ghost" id="btnSmtpHealth">SMTPæ¥ç¶šç¢ºèª</button>
          </div>
        </div>
        <p class="help">â€» APIã‚­ãƒ¼ãªã©ã®æ©Ÿå¾®æƒ…å ±ã¯ã‚µãƒ¼ãƒå´ã®ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨</p>
      </section>
      <section class="card">
        <h2>4) ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / ãƒªã‚¹ãƒˆã‚¢</h2>
        <div class="btns">
          <button class="ghost" id="btnExport">è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <input type="file" id="importFile" style="display:none" accept="application/json">
          <button class="danger" id="btnImport">è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
        <p class="help">è¨­å®šã¯ JSON ã¨ã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ãã¾ã™</p>
      </section>
    </div>
    <div class="btns">
      <button class="primary" id="btnSave">ä¿å­˜</button>
      <button class="ghost" id="btnReload">æœ€æ–°ã‚’å†èª­è¾¼</button>
      <button class="warn" id="btnReset">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
    </div>
    <div class="footer">Storage: <span id="storageType">â€”</span> / æœ€çµ‚æ›´æ–°: <span id="updatedAt">â€”</span></div>
  </div>
  <script>
(function(){
  console.log('âœ… Script loaded');
  const $=id=>document.getElementById(id);
  const msg=$('msg');
  const DEFAULTS={siteName:'138DataGate',logoUrl:'',notice:'',sessionTimeout:60,jwtExpiry:60,passwordPolicy:'medium',ipAllowlist:[],mailProvider:'sendgrid',sgFrom:'',smtpHost:'',smtpPort:587,smtpUser:'',smtpPass:'',smtpSecure:'starttls',smtpFrom:''};
  let msgTimeout;
  
  function show(type,text){
    console.log('ğŸ“¢ Show message:', type, text);
    if(msgTimeout)clearTimeout(msgTimeout);
    msg.className='msg '+(type==='ok'?'success':(type==='warn'?'warn':'error'));
    msg.textContent=text;
    msg.style.display='block';
    console.log('âœ… Message displayed, will hide in 8 seconds');
    msgTimeout=setTimeout(()=>{
      msg.style.display='none';
      console.log('ğŸ”„ Message hidden');
    },8000);
  }
  
  function toggle(){
    const pv=$('mailProvider').value;
    const isSmtp = pv === 'smtp';
    $('sendgridBlock').style.display=pv==='sendgrid'?'block':'none';
    $('smtpBlock').style.display=isSmtp?'block':'none';
    // SMTPé¸æŠæ™‚ã®ã¿æ¥ç¶šç¢ºèªãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    const healthCheckBtn = $('btnSmtpHealth');
    if(healthCheckBtn) healthCheckBtn.style.display = isSmtp ? 'inline-block' : 'none';
  }
  
  async function load(){
    console.log('ğŸ”„ Loading settings...');
    try{
      const res=await fetch('/api/settings/get');
      console.log('ğŸ“¡ Response status:', res.status);
      if(!res.ok)throw new Error('è¨­å®šã®å–å¾—ã«å¤±æ•—');
      const d=await res.json();
      console.log('ğŸ“¦ Data:', d);
      $('siteName').value=d.siteName||'';
      $('logoUrl').value=d.logoUrl||'';
      $('notice').value=d.notice||'';
      $('sessionTimeout').value=d.sessionTimeout??60;
      $('jwtExpiry').value=d.jwtExpiry??60;
      $('passwordPolicy').value=d.passwordPolicy||'medium';
      $('ipAllowlist').value=(d.ipAllowlist||[]).join(', ');
      $('mailProvider').value=d.mailProvider||'sendgrid';
      $('sgFrom').value=d.sgFrom||'';
      $('smtpHost').value=d.smtpHost||'';
      $('smtpPort').value=d.smtpPort||587;
      $('smtpUser').value=d.smtpUser||'';
      $('smtpPass').value='';
      $('smtpSecure').value=d.smtpSecure||'starttls';
      $('smtpFrom').value=d.smtpFrom||'';
      $('storageType').textContent=d.storageType||'-';
      $('updatedAt').textContent=d.updatedAt||'-';
      toggle();
      console.log('âœ… Settings loaded, showing message...');
      show('ok','âœ… è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
    }catch(e){
      console.error('âŒ Error:', e);
      show('ng','âŒ '+e.message);
    }
  }
  
  function reset(){
    console.log('ğŸ”„ Reset to defaults');
    if(!confirm('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ'))return;
    $('siteName').value=DEFAULTS.siteName;
    $('logoUrl').value=DEFAULTS.logoUrl;
    $('notice').value=DEFAULTS.notice;
    $('sessionTimeout').value=DEFAULTS.sessionTimeout;
    $('jwtExpiry').value=DEFAULTS.jwtExpiry;
    $('passwordPolicy').value=DEFAULTS.passwordPolicy;
    $('ipAllowlist').value=DEFAULTS.ipAllowlist.join(', ');
    $('mailProvider').value=DEFAULTS.mailProvider;
    $('sgFrom').value=DEFAULTS.sgFrom;
    $('smtpHost').value=DEFAULTS.smtpHost;
    $('smtpPort').value=DEFAULTS.smtpPort;
    $('smtpUser').value=DEFAULTS.smtpUser;
    $('smtpPass').value=DEFAULTS.smtpPass;
    $('smtpSecure').value=DEFAULTS.smtpSecure;
    $('smtpFrom').value=DEFAULTS.smtpFrom;
    toggle();
    show('ok','âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã—ã¾ã—ãŸ');
  }
  
  async function save(){
    console.log('ğŸ’¾ Saving...');
    const payload={
      siteName:$('siteName').value.trim(),
      logoUrl:$('logoUrl').value.trim(),
      notice:$('notice').value.trim(),
      sessionTimeout:Number($('sessionTimeout').value||60),
      jwtExpiry:Number($('jwtExpiry').value||60),
      passwordPolicy:$('passwordPolicy').value,
      ipAllowlist:$('ipAllowlist').value.split(',').map(s=>s.trim()).filter(Boolean),
      mailProvider:$('mailProvider').value,
      sgFrom:$('sgFrom').value.trim(),
      smtpHost:$('smtpHost').value.trim(),
      smtpPort:Number($('smtpPort').value||587),
      smtpUser:$('smtpUser').value.trim(),
      smtpPass:$('smtpPass').value.trim()||undefined,
      smtpSecure:$('smtpSecure').value,
      smtpFrom:$('smtpFrom').value.trim()
    };
    try{
      const res=await fetch('/api/settings/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const d=await res.json();
      console.log('ğŸ“¡ Save response:', d);
      if(!res.ok||!d.success)throw new Error(d.error||'ä¿å­˜å¤±æ•—');
      $('updatedAt').textContent=d.updatedAt||'-';
      $('storageType').textContent=d.storageType||'-';
      show('ok','âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }catch(e){
      console.error('âŒ Save error:', e);
      show('ng','âŒ '+e.message);
    }
  }
  
  async function exp(){
    console.log('ğŸ“¤ Exporting...');
    try{
      const res=await fetch('/api/settings/export');
      if(!res.ok){show('ng','âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—');return;}
      const blob=await res.blob();
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download='datagate-settings.json';
      a.click();
      URL.revokeObjectURL(url);
      show('ok','âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
    }catch(e){
      console.error('âŒ Export error:', e);
      show('ng','âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—');
    }
  }
  
  async function imp(e){
    const file=e.target.files[0];
    if(!file)return;
    console.log('ğŸ“¥ Importing:', file.name);
    const text=await file.text();
    try{
      const res=await fetch('/api/settings/import',{method:'POST',headers:{'Content-Type':'application/json'},body:text});
      const d=await res.json();
      if(!res.ok||!d.success)throw new Error(d.error||'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—');
      show('ok','âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
      load();
    }catch(err){
      console.error('âŒ Import error:', err);
      show('ng','âŒ '+err.message);
    }
  }
  
  async function testMail(){
    const to=prompt('é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹');
    if(!to)return;
    console.log('ğŸ“§ Test mail to:', to);
    try{
      const res=await fetch('/api/settings/test-mail',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to})});
      const d=await res.json();
      console.log('ğŸ“§ Mail response:', d);
      if(!res.ok||!d.success)throw new Error(d.error||'é€ä¿¡å¤±æ•—');
      show('ok','âœ… '+d.message);
    }catch(e){
      console.error('âŒ Mail error:', e);
      show('ng','âŒ '+e.message);
    }
  }

  // â–¼â–¼â–¼ ç½®ãæ›ãˆãŸJavaScripté–¢æ•° â–¼â–¼â–¼
  async function checkSmtp() {
    console.log('ğŸ©º SMTPæ¥ç¶šç¢ºèªã‚’é–‹å§‹...');
    // æ¥ç¶šè©¦è¡Œä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
    show('ok', 'â³ SMTPã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã‚’ç¢ºèªã—ã¦ã„ã¾ã™...');
    try {
      // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const token = localStorage.getItem('adminToken');
      if (!token) {
        throw new Error('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
      }
      // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™
      const res = await fetch('/api/health/smtp', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      const d = await res.json();
      console.log('ğŸ©º SMTPæ¥ç¶šç¢ºèªã®çµæœ:', d);
      // çµæœãŒã‚¨ãƒ©ãƒ¼ã§ãªã„ã‹ç¢ºèª
      if (!res.ok || !d.success) {
        // è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const errorMsg = d.health?.details?.map(detail => detail.message).join(', ') || d.error || 'æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ';
        throw new Error(errorMsg);
      }
      // æ¥ç¶šæ™‚é–“ã‚’å–å¾—
      const responseTime = d.health?.checks?.connection?.responseTime || 'ä¸æ˜';
      const overallStatus = d.health?.overall || 'unknown';
      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      if (overallStatus === 'healthy') {
        show('ok', `âœ… SMTPæ¥ç¶šãŒæ­£å¸¸ã§ã™ï¼ˆå¿œç­”æ™‚é–“: ${responseTime}ï¼‰`);
      } else if (overallStatus === 'degraded') {
        show('warn', `âš ï¸ SMTPæ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼ˆå¿œç­”æ™‚é–“: ${responseTime}ï¼‰`);
      } else {
        show('error', 'âŒ SMTPæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (e) {
      console.error('SMTPæ¥ç¶šç¢ºèªã‚¨ãƒ©ãƒ¼:', e);
      show('error', 'âŒ ' + e.message);
    }
  }
  // â–²â–²â–² ç½®ãæ›ãˆãŸJavaScripté–¢æ•° â–²â–²â–²
  
  console.log('ğŸ”— Attaching event listeners...');
  $('mailProvider').addEventListener('change',toggle);
  $('btnReload').addEventListener('click',()=>{console.log('ğŸ”„ Reload clicked');load();});
  $('btnSave').addEventListener('click',()=>{console.log('ğŸ’¾ Save clicked');save();});
  $('btnReset').addEventListener('click',()=>{console.log('ğŸ”„ Reset clicked');reset();});
  $('btnExport').addEventListener('click',()=>{console.log('ğŸ“¤ Export clicked');exp();});
  $('btnImport').addEventListener('click',()=>$('importFile').click());
  $('importFile').addEventListener('change',imp);
  $('btnTestMail').addEventListener('click',()=>{console.log('ğŸ“§ Test mail clicked');testMail();});
  // â–¼â–¼â–¼ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯å¤‰æ›´ãªã— â–¼â–¼â–¼
  $('btnSmtpHealth').addEventListener('click', ()=>{console.log('ğŸ©º SMTP Health Check clicked'); checkSmtp();});
  // â–²â–²â–² ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯å¤‰æ›´ãªã— â–²â–²â–²
  
  console.log('âœ… Event listeners attached');
  console.log('ğŸ”„ Initial load...');
  load();
})();
  </script>
</body>
</html>