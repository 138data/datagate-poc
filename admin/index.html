<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>138DataGate ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  */
    #loginForm {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-width: 400px;
      margin: 100px auto;
    }
    #loginForm h1 {
      color: #667eea;
      margin-bottom: 30px;
      text-align: center;
    }
    #loginForm input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
    }
    #loginForm input:focus {
      outline: none;
      border-color: #667eea;
    }
    #loginForm button {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    #loginForm button:hover {
      background: #5568d3;
    }
    .error-msg {
      color: #e74c3c;
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
    }
    
    /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
    #dashboard {
      display: none;
    }
    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      color: #667eea;
      font-size: 28px;
    }
    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .period-select {
      padding: 8px 15px;
      border: 2px solid #667eea;
      border-radius: 8px;
      background: white;
      color: #667eea;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
    }
    .logout-btn {
      padding: 8px 20px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
    }
    .logout-btn:hover {
      background: #c0392b;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .stat-card h3 {
      color: #666;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
    }
    .stat-card .value {
      color: #667eea;
      font-size: 36px;
      font-weight: bold;
    }
    
    .chart-section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .chart-section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 20px;
    }
    .chart-container {
      position: relative;
      height: 300px;
    }
    
    .logs-section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .logs-section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 20px;
    }
    .log-table {
      width: 100%;
      border-collapse: collapse;
    }
    .log-table th {
      background: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-size: 14px;
      color: #666;
    }
    .log-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    .badge-link { background: #3498db; color: white; }
    .badge-attach { background: #2ecc71; color: white; }
    .badge-blocked { background: #e74c3c; color: white; }
  </style>
</head>
<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div id="loginForm">
    <h1>ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h1>
    <input type="text" id="username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" autocomplete="username">
    <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password">
    <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <div id="loginError" class="error-msg"></div>
  </div>

  <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
  <div id="dashboard" class="container">
    <div class="header">
      <h1>ğŸ“Š 138DataGate ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <div class="header-actions">
        <select class="period-select" id="periodSelect" onchange="loadStats()">
          <option value="7">ç›´è¿‘7æ—¥</option>
          <option value="30">ç›´è¿‘30æ—¥</option>
          <option value="90">ç›´è¿‘90æ—¥</option>
        </select>
        <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>ç·ã‚¤ãƒ™ãƒ³ãƒˆæ•°</h3>
        <div class="value" id="totalEvents">-</div>
      </div>
      <div class="stat-card">
        <h3>Linké€ä»˜</h3>
        <div class="value" id="linkCount">-</div>
      </div>
      <div class="stat-card">
        <h3>æ·»ä»˜ç›´é€</h3>
        <div class="value" id="attachCount">-</div>
      </div>
      <div class="stat-card">
        <h3>ãƒ–ãƒ­ãƒƒã‚¯</h3>
        <div class="value" id="blockedCount">-</div>
      </div>
    </div>

    <div class="chart-section">
      <h2>ğŸ“ˆ é…ä¿¡ãƒ¢ãƒ¼ãƒ‰åˆ†å¸ƒ</h2>
      <div class="chart-container">
        <canvas id="modeChart"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <h2>ğŸ” ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç†ç”±</h2>
      <div class="chart-container">
        <canvas id="reasonChart"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <h2>ğŸ“… æ—¥åˆ¥æ¨ç§»</h2>
      <div class="chart-container">
        <canvas id="dailyChart"></canvas>
      </div>
    </div>

    <div class="logs-section">
      <h2>ğŸ“‹ æœ€æ–°ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç›´è¿‘20ä»¶ï¼‰</h2>
      <table class="log-table">
        <thead>
          <tr>
            <th>æ—¥æ™‚</th>
            <th>å®›å…ˆ</th>
            <th>Mode</th>
            <th>Reason</th>
            <th>ã‚µã‚¤ã‚º</th>
          </tr>
        </thead>
        <tbody id="logsTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    let charts = {};
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.onload = () => {
      const token = localStorage.getItem('adminToken');
      if (token) {
        // ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        loadStats();
      }
    };
    
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('loginError');
      
      if (!username || !password) {
        errorDiv.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        return;
      }
      
      try {
        const response = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          localStorage.setItem('adminToken', data.token);
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
          loadStats();
        } else {
          errorDiv.textContent = data.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
        }
      } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      }
    }
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    function logout() {
      localStorage.removeItem('adminToken');
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('loginError').textContent = '';
    }
    
    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadStats() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        logout();
        return;
      }
      
      const days = document.getElementById('periodSelect').value;
      
      try {
        const response = await fetch(`/api/admin/stats?days=${days}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.status === 401) {
          alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæœŸé™åˆ‡ã‚Œã§ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
          logout();
          return;
        }
        
        const data = await response.json();
        updateDashboard(data);
      } catch (error) {
        console.error('Stats error:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
    function updateDashboard(data) {
      // ã‚µãƒãƒªãƒ¼æ›´æ–°
      document.getElementById('totalEvents').textContent = data.summary.total;
      document.getElementById('linkCount').textContent = data.summary.modes.link || 0;
      document.getElementById('attachCount').textContent = data.summary.modes.attach || 0;
      document.getElementById('blockedCount').textContent = data.summary.modes.blocked || 0;
      
      // Modeãƒãƒ£ãƒ¼ãƒˆ
      if (charts.mode) charts.mode.destroy();
      charts.mode = new Chart(document.getElementById('modeChart'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(data.summary.modes),
          datasets: [{
            data: Object.values(data.summary.modes),
            backgroundColor: ['#3498db', '#2ecc71', '#e74c3c']
          }]
        }
      });
      
      // Reasonãƒãƒ£ãƒ¼ãƒˆ
      if (charts.reason) charts.reason.destroy();
      charts.reason = new Chart(document.getElementById('reasonChart'), {
        type: 'bar',
        data: {
          labels: Object.keys(data.summary.reasons),
          datasets: [{
            label: 'ã‚¤ãƒ™ãƒ³ãƒˆæ•°',
            data: Object.values(data.summary.reasons),
            backgroundColor: '#667eea'
          }]
        }
      });
      
      // æ—¥åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
      if (charts.daily) charts.daily.destroy();
      charts.daily = new Chart(document.getElementById('dailyChart'), {
        type: 'line',
        data: {
          labels: data.daily.map(d => d.date),
          datasets: [
            {
              label: 'Link',
              data: data.daily.map(d => d.link),
              borderColor: '#3498db',
              fill: false
            },
            {
              label: 'Attach',
              data: data.daily.map(d => d.attach),
              borderColor: '#2ecc71',
              fill: false
            },
            {
              label: 'Blocked',
              data: data.daily.map(d => d.blocked),
              borderColor: '#e74c3c',
              fill: false
            }
          ]
        }
      });
      
      // ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
      const tbody = document.getElementById('logsTable');
      tbody.innerHTML = '';
      data.recentLogs.forEach(log => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = new Date(log.timestamp).toLocaleString('ja-JP');
        row.insertCell(1).textContent = log.to || '-';
        const modeCell = row.insertCell(2);
        modeCell.innerHTML = `<span class="badge badge-${log.mode}">${log.mode}</span>`;
        row.insertCell(3).textContent = log.reason || '-';
        row.insertCell(4).textContent = log.size ? `${(log.size / 1024).toFixed(1)} KB` : '-';
      });
    }
    
    // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') login();
      });
    });
  </script>
</body>
</html>