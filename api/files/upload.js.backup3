// api/files/upload.js
// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰APIï¼ˆPhase 21: KPIè¨˜éŒ²ãƒ»åœ§ç¸®æ©Ÿèƒ½è¿½åŠ ç‰ˆï¼‰

const { formidable } = require('formidable');
const fs = require('fs').promises;
const path = require('path');
const crypto = require('crypto');
const { encryptFile, encryptString } = require('../../lib/encryption');
const zlib = require('zlib');
const { promisify } = require('util');

const gzip = promisify(zlib.gzip);

module.exports = async (req, res) => {
    // CORSãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    // OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†
    if (req.method === 'OPTIONS') {
        return res.status(200).end();
    }

    // POSTãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿è¨±å¯
    if (req.method !== 'POST') {
        return res.status(405).json({
            success: false,
            error: 'Method not allowed'
        });
    }

    const startTime = Date.now();
    let kv = null;

    try {
        // KVæ¥ç¶š
        try {
            kv = require('@vercel/kv');
        } catch (error) {
            console.log('KV not available (development mode)');
        }

        // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã‚’å–å¾—
        const MAX_FILE_SIZE = parseInt(process.env.MAX_FILE_SIZE) || 104857600; // 100MB
        const ENABLE_COMPRESSION = process.env.ENABLE_COMPRESSION === 'true';

        // formidableã®è¨­å®š
        const form = formidable({
            maxFileSize: MAX_FILE_SIZE,
            keepExtensions: true,
            multiples: false
        });

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
        const [fields, files] = await new Promise((resolve, reject) => {
            form.parse(req, (err, fields, files) => {
                if (err) reject(err);
                else resolve([fields, files]);
            });
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—
        const uploadedFile = files.file ? (Array.isArray(files.file) ? files.file[0] : files.file) : null;
        
        if (!uploadedFile) {
            return res.status(400).json({
                success: false,
                error: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
            });
        }

        // é€ä¿¡è€…ãƒ»å—ä¿¡è€…æƒ…å ±ã®å–å¾—
	// formidable v3å¯¾å¿œ: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯é…åˆ—ã§è¿”ã•ã‚Œã‚‹
	const sender = (Array.isArray(fields.sender) ? fields.sender[0] : fields.sender) || '';
	const recipient = (Array.isArray(fields.recipient) ? fields.recipient[0] : fields.recipient) || '';
	const message = (Array.isArray(fields.message) ? fields.message[0] : fields.message) || '';

	// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
	console.log('ğŸ” fields.sender:', fields.sender);
	console.log('ğŸ” fields.recipient:', fields.recipient);
	console.log('ğŸ” sender:', sender);
	console.log('ğŸ” recipient:', recipient);

        if (!sender || !recipient) {
            return res.status(400).json({
                success: false,
                error: 'é€ä¿¡è€…ã¨å—ä¿¡è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¿…è¦ã§ã™'
            });
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
        const originalFileName = uploadedFile.originalFilename || 'untitled';
        const originalSize = uploadedFile.size;
        const filePath = uploadedFile.filepath;

        console.log('ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹:', {
            fileName: originalFileName,
            size: originalSize,
            sender,
            recipient,
            compression: ENABLE_COMPRESSION
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Bufferã«èª­ã¿è¾¼ã¿
        let fileBuffer = await fs.readFile(filePath);
        let processedSize = originalSize;
        let compressionRatio = 0;

        // ğŸ†• Phase 21: åœ§ç¸®æ©Ÿèƒ½
        if (ENABLE_COMPRESSION && originalSize > 1024) { // 1KBä»¥ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿åœ§ç¸®
            try {
                const compressedBuffer = await gzip(fileBuffer);
                const compressedSize = compressedBuffer.length;
                
                // åœ§ç¸®ç‡ã‚’è¨ˆç®—
                compressionRatio = ((originalSize - compressedSize) / originalSize) * 100;
                
                console.log('ğŸ—œï¸ åœ§ç¸®çµæœ:', {
                    originalSize,
                    compressedSize,
                    ratio: `${compressionRatio.toFixed(1)}%`
                });

                // åœ§ç¸®åŠ¹æœãŒã‚ã‚‹å ´åˆã®ã¿åœ§ç¸®ç‰ˆã‚’ä½¿ç”¨ï¼ˆ5%ä»¥ä¸Šï¼‰
                if (compressionRatio > 5) {
                    fileBuffer = compressedBuffer;
                    processedSize = compressedSize;
                } else {
                    compressionRatio = 0; // åœ§ç¸®åŠ¹æœãªã—
                }
            } catch (compressionError) {
                console.error('åœ§ç¸®ã‚¨ãƒ©ãƒ¼ï¼ˆå…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰:', compressionError);
                compressionRatio = 0;
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æš—å·åŒ–
        const fileId = crypto.randomUUID();
        const encryptedFile = encryptFile(fileBuffer);

        // storageãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèªãƒ»ä½œæˆ
        const storageDir = '/tmp';
        // /tmpã¯å¸¸ã«å­˜åœ¨ã™ã‚‹ã®ã§ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã¯ä¸è¦

        // æš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
        const encryptedFilePath = path.join(storageDir, `${fileId}.enc`);
        await fs.writeFile(encryptedFilePath, encryptedFile.encryptedData);

        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–
        const encryptedFileName = encryptString(originalFileName);
        const encryptedSender = encryptString(sender);
        const encryptedRecipient = encryptString(recipient);
        const encryptedMessage = message ? encryptString(message) : null;

        // æœ‰åŠ¹æœŸé™ã‚’è¨­å®šï¼ˆ7æ—¥å¾Œï¼‰
        const uploadedAt = new Date();
        const expiresAt = new Date(uploadedAt.getTime() + 7 * 24 * 60 * 60 * 1000);

        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        const fileMetadata = {
            id: fileId,
            
            // æš—å·åŒ–ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«å
            fileName: encryptedFileName.data,
            fileNameSalt: encryptedFileName.salt,
            fileNameIv: encryptedFileName.iv,
            fileNameAuthTag: encryptedFileName.authTag,
            
            // æš—å·åŒ–ã•ã‚ŒãŸé€ä¿¡è€…
            sender: encryptedSender.data,
            senderSalt: encryptedSender.salt,
            senderIv: encryptedSender.iv,
            senderAuthTag: encryptedSender.authTag,
            
            // æš—å·åŒ–ã•ã‚ŒãŸå—ä¿¡è€…
            recipient: encryptedRecipient.data,
            recipientSalt: encryptedRecipient.salt,
            recipientIv: encryptedRecipient.iv,
            recipientAuthTag: encryptedRecipient.authTag,
            
            // æš—å·åŒ–ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            message: encryptedMessage ? encryptedMessage.data : null,
            messageSalt: encryptedMessage ? encryptedMessage.salt : null,
            messageIv: encryptedMessage ? encryptedMessage.iv : null,
            messageAuthTag: encryptedMessage ? encryptedMessage.authTag : null,
            
            // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
            originalSize: originalSize,
            processedSize: processedSize,
            compressed: compressionRatio > 0,
            compressionRatio: compressionRatio,
            
            // æš—å·åŒ–æƒ…å ±
            fileSalt: encryptedFile.salt,
            fileIv: encryptedFile.iv,
            fileAuthTag: encryptedFile.authTag,
            
            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
            uploadedAt: uploadedAt.toISOString(),
            expiresAt: expiresAt.toISOString()
        };

        // KVã«ä¿å­˜ï¼ˆ7æ—¥é–“ã®TTLï¼‰
        if (kv) {
            const ttl = 7 * 24 * 60 * 60; // 7æ—¥é–“ï¼ˆç§’ï¼‰
            await kv.set(`file:${fileId}`, fileMetadata, { ex: ttl });
            console.log('âœ… KVã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆTTL: 7æ—¥ï¼‰');
        }

        // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        try {
            await fs.unlink(filePath);
        } catch (error) {
            console.error('ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        }

        // ğŸ†• Phase 21: KPIçµ±è¨ˆã‚’æ›´æ–°
        const processingTime = Date.now() - startTime;
        const transferSpeed = (processedSize / 1024 / 1024) / (processingTime / 1000); // MB/s

        if (kv) {
            try {
                // æ—¢å­˜ã®KPIçµ±è¨ˆã‚’å–å¾—
                let kpiStats = await kv.get('kpi:stats') || {
                    transferSpeeds: [],
                    compressionRatios: [],
                    uploadAttempts: 0,
                    uploadSuccesses: 0,
                    fileSizes: []
                };

                // è»¢é€é€Ÿåº¦ã‚’è¨˜éŒ²ï¼ˆç›´è¿‘100ä»¶ã¾ã§ï¼‰
                kpiStats.transferSpeeds.push(transferSpeed);
                if (kpiStats.transferSpeeds.length > 100) {
                    kpiStats.transferSpeeds.shift();
                }

                // åœ§ç¸®ç‡ã‚’è¨˜éŒ²ï¼ˆåœ§ç¸®ã—ãŸå ´åˆã®ã¿ï¼‰
                if (compressionRatio > 0) {
                    kpiStats.compressionRatios.push(compressionRatio);
                    if (kpiStats.compressionRatios.length > 100) {
                        kpiStats.compressionRatios.shift();
                    }
                }

                // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è©¦è¡Œå›æ•°ã¨æˆåŠŸå›æ•°ã‚’è¨˜éŒ²
                kpiStats.uploadAttempts++;
                kpiStats.uploadSuccesses++;

                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’è¨˜éŒ²ï¼ˆç›´è¿‘100ä»¶ã¾ã§ï¼‰
                kpiStats.fileSizes.push(originalSize);
                if (kpiStats.fileSizes.length > 100) {
                    kpiStats.fileSizes.shift();
                }

                // KPIçµ±è¨ˆã‚’ä¿å­˜ï¼ˆ30æ—¥é–“ä¿æŒï¼‰
                await kv.set('kpi:stats', kpiStats, { ex: 30 * 24 * 60 * 60 });

                console.log('ğŸ“Š KPIçµ±è¨ˆã‚’æ›´æ–°ã—ã¾ã—ãŸ:', {
                    transferSpeed: `${transferSpeed.toFixed(2)} MB/s`,
                    compressionRatio: compressionRatio > 0 ? `${compressionRatio.toFixed(1)}%` : 'ãªã—',
                    processingTime: `${processingTime}ms`
                });
            } catch (kpiError) {
                console.error('KPIçµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', kpiError);
                // KPIæ›´æ–°ã‚¨ãƒ©ãƒ¼ã¯è‡´å‘½çš„ã§ã¯ãªã„ã®ã§ç¶šè¡Œ
            }
        }

        console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†:', {
            fileId,
            processingTime: `${processingTime}ms`,
            transferSpeed: `${transferSpeed.toFixed(2)} MB/s`
        });

        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
        return res.status(200).json({
            success: true,
            message: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ',
            file: {
                id: fileId,
                originalSize: originalSize,
                processedSize: processedSize,
                compressed: compressionRatio > 0,
                compressionRatio: compressionRatio > 0 ? `${compressionRatio.toFixed(1)}%` : null,
                uploadedAt: uploadedAt.toISOString(),
                expiresAt: expiresAt.toISOString(),
                processingTime: `${processingTime}ms`,
                transferSpeed: `${transferSpeed.toFixed(2)} MB/s`
            }
        });

    } catch (error) {
        console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);

        // ğŸ†• Phase 21: å¤±æ•—ã‚‚KPIçµ±è¨ˆã«è¨˜éŒ²
        if (kv) {
            try {
                let kpiStats = await kv.get('kpi:stats') || {
                    transferSpeeds: [],
                    compressionRatios: [],
                    uploadAttempts: 0,
                    uploadSuccesses: 0,
                    fileSizes: []
                };
                
                kpiStats.uploadAttempts++;
                await kv.set('kpi:stats', kpiStats, { ex: 30 * 24 * 60 * 60 });
            } catch (kpiError) {
                console.error('KPIçµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', kpiError);
            }
        }

        return res.status(500).json({
            success: false,
            error: 'ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ',
            details: error.message
        });
    }
};
