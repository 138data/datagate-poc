<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ - 138DataGate</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .file-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .file-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .file-info-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .file-info-label {
            color: #666;
            font-size: 14px;
        }

        .file-info-value {
            color: #333;
            font-weight: 500;
            font-size: 14px;
            text-align: right;
        }

        .download-count {
            color: #764ba2;
            font-weight: 600;
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .message-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .message-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .otp-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 24px;
            text-align: center;
            letter-spacing: 8px;
            transition: all 0.3s;
        }

        .otp-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .otp-attempts {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            color: #856404;
            font-size: 13px;
            text-align: center;
        }

        .download-btn {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .download-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .download-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .help-text {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-top: 12px;
            line-height: 1.6;
        }

        .help-text-icon {
            margin-right: 4px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-icon">ğŸ“¥</div>
            <h1>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h1>
            <p>å®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«å—ã‘æ¸¡ã—</p>
        </div>

        <div class="file-info" id="file-info">
            <div class="file-info-item">
                <span class="file-info-label">ãƒ•ã‚¡ã‚¤ãƒ«å</span>
                <span class="file-info-value" id="file-name">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <div class="file-info-item">
                <span class="file-info-label">ã‚µã‚¤ã‚º</span>
                <span class="file-info-value" id="file-size">-</span>
            </div>
            <div class="file-info-item">
                <span class="file-info-label">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å›æ•°</span>
                <span class="file-info-value download-count" id="download-count">-</span>
            </div>
            <div class="file-info-item">
                <span class="file-info-label">æœ‰åŠ¹æœŸé™</span>
                <span class="file-info-value" id="expires-at">-</span>
            </div>
        </div>

        <div id="message-container"></div>

        <form id="download-form">
            <div class="form-group">
                <label class="form-label" for="otp">èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆ6æ¡ã®æ•°å­—ï¼‰</label>
                <input 
                    type="text" 
                    id="otp" 
                    class="otp-input" 
                    maxlength="6" 
                    pattern="[0-9]{6}" 
                    placeholder="000000"
                    autocomplete="off"
                    required
                >
                <div class="otp-attempts" id="otp-attempts" style="display: none;"></div>
            </div>
            <button type="button" id="download-btn" class="download-btn">
                âœ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†
            </button>
            <div class="help-text">
                <div><span class="help-text-icon">ğŸ”</span>ãƒ¡ãƒ¼ãƒ«ã«å±Šã„ãŸ6æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                <div><span class="help-text-icon">âŒ¨ï¸</span>Enterã‚­ãƒ¼ã§ã‚‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</div>
            </div>
        </form>
    </div>

    <script>
        var fileId = new URLSearchParams(window.location.search).get('fileId');
        var otpInput = document.getElementById('otp');
        var downloadBtn = document.getElementById('download-btn');
        var messageContainer = document.getElementById('message-container');
        var otpAttemptsDiv = document.getElementById('otp-attempts');
        var isDownloading = false;

        function showMessage(type, text) {
            messageContainer.innerHTML = '<div class="message message-' + type + '">' + text + '</div>';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            var k = 1024;
            var sizes = ['B', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(isoString) {
            var date = new Date(isoString);
            var year = date.getFullYear();
            var month = ('0' + (date.getMonth() + 1)).slice(-2);
            var day = ('0' + date.getDate()).slice(-2);
            var hours = ('0' + date.getHours()).slice(-2);
            var minutes = ('0' + date.getMinutes()).slice(-2);
            return year + '/' + month + '/' + day + ' ' + hours + ':' + minutes;
        }

        fetch('/api/files/download?id=' + fileId)
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (!data.success) {
                    showMessage('error', data.message || 'ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    downloadBtn.disabled = true;
                    return;
                }

                document.getElementById('file-name').textContent = data.fileName;
                document.getElementById('file-size').textContent = formatBytes(data.fileSize);
                document.getElementById('download-count').textContent = data.downloadCount + ' / ' + data.maxDownloads + 'å›';
                document.getElementById('expires-at').textContent = formatDate(data.expiresAt);

                if (data.otpAttempts > 0) {
                    var remaining = data.maxOtpAttempts - data.otpAttempts;
                    otpAttemptsDiv.textContent = 'âŒ èªè¨¼å¤±æ•— ' + data.otpAttempts + 'å› / æ®‹ã‚Š ' + remaining + 'å›';
                    otpAttemptsDiv.style.display = 'block';
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                showMessage('error', 'ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                downloadBtn.disabled = true;
            });

        function handleDownload() {
            if (isDownloading) {
                return;
            }

            var otp = otpInput.value.trim();
            if (!otp || otp.length !== 6) {
                showMessage('warning', '6æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            isDownloading = true;
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<span class="loading"></span> å‡¦ç†ä¸­...';

            fetch('/api/files/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileId: fileId, otp: otp })
            })
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(data) {
                        throw data;
                    });
                }
                return response.blob().then(function(blob) {
                    return {
                        blob: blob,
                        filename: decodeURIComponent(
                            response.headers.get('Content-Disposition')
                                .split('filename*=UTF-8\'\'')[1] || 'download.txt'
                        )
                    };
                });
            })
            .then(function(result) {
                var url = window.URL.createObjectURL(result.blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = result.filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showMessage('success', 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ');
                downloadBtn.innerHTML = 'âœ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†';
                otpAttemptsDiv.style.display = 'none';
                isDownloading = false;
            })
            .catch(function(error) {
                console.error('Download error:', error);
                
                var errorMsg = error.message || 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ';
                
                if (error.locked) {
                    showMessage('error', 'âŒ ' + errorMsg + ' - ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ');
                    downloadBtn.disabled = true;
                    downloadBtn.innerHTML = 'ğŸ”’ ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ';
                    otpInput.disabled = true;
                } else {
                    showMessage('error', errorMsg);
                    
                    if (error.otpAttempts !== undefined) {
                        var remaining = error.maxOtpAttempts - error.otpAttempts;
                        otpAttemptsDiv.textContent = 'âŒ èªè¨¼å¤±æ•— ' + error.otpAttempts + 'å› / æ®‹ã‚Š ' + remaining + 'å›';
                        otpAttemptsDiv.style.display = 'block';
                        
                        if (remaining === 0) {
                            downloadBtn.disabled = true;
                            downloadBtn.innerHTML = 'ğŸ”’ ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ';
                            otpInput.disabled = true;
                        }
                    }
                    
                    otpInput.value = '';
                    otpInput.disabled = false;
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = 'âœ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†';
                    otpInput.focus();
                }
                
                isDownloading = false;
            });
        }

        downloadBtn.addEventListener('click', handleDownload);

        otpInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleDownload();
            }
        });

        otpInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>
