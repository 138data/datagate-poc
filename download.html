<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ - 138DataGate</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 500px;
      width: 100%;
    }

    h1 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
      text-align: center;
      margin-bottom: 30px;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .file-info {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .file-info-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .file-info-item:last-child {
      border-bottom: none;
    }

    .file-info-label {
      color: #666;
      font-size: 13px;
      font-weight: 500;
    }

    .file-info-value {
      color: #333;
      font-size: 14px;
      font-weight: 600;
    }

    .masked-email {
      background: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .masked-email-label {
      color: #856404;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .masked-email-value {
      color: #333;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      color: #333;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .input-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      width: 100%;
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(17, 153, 142, 0.4);
    }

    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: center;
    }

    .message-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }

    .spinner {
      display: none;
      width: 40px;
      height: 40px;
      margin: 20px auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .help-text {
      font-size: 13px;
      color: #666;
      margin-top: 10px;
      line-height: 1.5;
    }

    .progress-bar {
      background: #e9ecef;
      height: 4px;
      border-radius: 2px;
      margin-bottom: 30px;
      overflow: hidden;
    }

    .progress-bar-fill {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h1>
    <p class="subtitle">å®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«å—ã‘æ¸¡ã—</p>

    <div class="progress-bar">
      <div class="progress-bar-fill" id="progress-fill"></div>
    </div>

    <!-- Step 1: å®›å…ˆç¢ºèª + OTPé€ä¿¡ -->
    <div class="step active" id="step1">
      <div class="file-info" id="file-info-section" style="display: none;">
        <div class="file-info-item">
          <span class="file-info-label">ãƒ•ã‚¡ã‚¤ãƒ«å</span>
          <span class="file-info-value" id="file-name">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
        <div class="file-info-item">
          <span class="file-info-label">ã‚µã‚¤ã‚º</span>
          <span class="file-info-value" id="file-size">-</span>
        </div>
        <div class="file-info-item">
          <span class="file-info-label">æœ‰åŠ¹æœŸé™</span>
          <span class="file-info-value" id="expires-at">-</span>
        </div>
      </div>

      <div class="masked-email">
        <div class="masked-email-label">é€ä¿¡å…ˆ</div>
        <div class="masked-email-value" id="masked-email">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>

      <div id="message1"></div>

      <button id="request-otp-btn" class="btn btn-primary" disabled>
        ğŸ“§ èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡
      </button>

      <p class="help-text">
        ä¸Šè¨˜ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å®›ã¦ã«ã€6æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã™ã€‚
      </p>
    </div>

    <!-- Step 2: OTPå…¥åŠ› + ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
    <div class="step" id="step2">
      <div class="message message-success">
        âœ… èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ
      </div>

      <div class="input-group">
        <label for="otp-input">èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆ6æ¡ï¼‰</label>
        <input 
          type="text" 
          id="otp-input" 
          placeholder="ä¾‹: 123456" 
          maxlength="6"
          pattern="[0-9]{6}"
          inputmode="numeric"
          autocomplete="off"
        >
      </div>

      <div id="message2"></div>

      <button id="download-btn" class="btn btn-success">
        â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      </button>

      <p class="help-text">
        ãƒ¡ãƒ¼ãƒ«ã«å±Šã„ãŸ6æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
      </p>
    </div>

    <div class="spinner" id="spinner"></div>
  </div>

  <script>
    // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ fileId ã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const fileId = urlParams.get('id');

    if (!fileId) {
      alert('ãƒ•ã‚¡ã‚¤ãƒ«IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      window.location.href = '/';
    }

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const progressFill = document.getElementById('progress-fill');
    const requestOtpBtn = document.getElementById('request-otp-btn');
    const downloadBtn = document.getElementById('download-btn');
    const otpInput = document.getElementById('otp-input');
    const message1 = document.getElementById('message1');
    const message2 = document.getElementById('message2');
    const spinner = document.getElementById('spinner');

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
    async function loadFileInfo() {
      try {
        spinner.style.display = 'block';

        const response = await fetch(`/api/files/download?id=${fileId}`);
        const data = await response.json();

        spinner.style.display = 'none';

        if (!data.success) {
          message1.innerHTML = `<div class="message message-error">${data.message}</div>`;
          return;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
        document.getElementById('file-name').textContent = data.fileName;
        document.getElementById('file-size').textContent = formatFileSize(data.fileSize);
        document.getElementById('expires-at').textContent = formatDate(data.expiresAt);
        document.getElementById('file-info-section').style.display = 'block';

        // ãƒã‚¹ã‚¯è¡¨ç¤º
        document.getElementById('masked-email').textContent = data.maskedEmail;

        // OTPé€ä¿¡ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        requestOtpBtn.disabled = false;
      } catch (error) {
        spinner.style.display = 'none';
        message1.innerHTML = '<div class="message message-error">ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        console.error('Error loading file info:', error);
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(isoString) {
      const date = new Date(isoString);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Step 1 â†’ Step 2
    requestOtpBtn.addEventListener('click', async () => {
      requestOtpBtn.disabled = true;
      spinner.style.display = 'block';
      message1.innerHTML = '';

      try {
        const response = await fetch('/api/files/download/request-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fileId })  // email ã¯ä¸è¦
        });

        const data = await response.json();
        spinner.style.display = 'none';

        if (data.success) {
          // Step 2 ã«é€²ã‚€
          step1.classList.remove('active');
          step2.classList.add('active');
          progressFill.style.width = '50%';
        } else {
          message1.innerHTML = `<div class="message message-error">${data.message}</div>`;
          requestOtpBtn.disabled = false;
        }
      } catch (error) {
        spinner.style.display = 'none';
        message1.innerHTML = '<div class="message message-error">èªè¨¼ã‚³ãƒ¼ãƒ‰ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        requestOtpBtn.disabled = false;
        console.error('Error requesting OTP:', error);
      }
    });

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    downloadBtn.addEventListener('click', async () => {
      const otp = otpInput.value.trim();

      if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
        message2.innerHTML = '<div class="message message-error">èªè¨¼ã‚³ãƒ¼ãƒ‰ã¯6æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
        return;
      }

      downloadBtn.disabled = true;
      spinner.style.display = 'block';
      message2.innerHTML = '';

      try {
        const response = await fetch('/api/files/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fileId, otp })
        });

        spinner.style.display = 'none';

        if (response.ok) {
          // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;

          // Content-Disposition ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
          const contentDisposition = response.headers.get('Content-Disposition');
          let fileName = 'download.txt';
          if (contentDisposition) {
            const fileNameMatch = contentDisposition.match(/filename\*=UTF-8''(.+)/);
            if (fileNameMatch) {
              fileName = decodeURIComponent(fileNameMatch[1]);
            }
          }

          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          progressFill.style.width = '100%';
          message2.innerHTML = '<div class="message message-success">âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ</div>';
          downloadBtn.textContent = 'âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†';
          downloadBtn.disabled = true;
        } else {
          const data = await response.json();
          message2.innerHTML = `<div class="message message-error">${data.message}</div>`;
          downloadBtn.disabled = false;
        }
      } catch (error) {
        spinner.style.display = 'none';
        message2.innerHTML = '<div class="message message-error">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        downloadBtn.disabled = false;
        console.error('Error downloading file:', error);
      }
    });

    // OTPå…¥åŠ›æ™‚ã«ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    otpInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        downloadBtn.click();
      }
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
    loadFileInfo();
  </script>
</body>
</html>
